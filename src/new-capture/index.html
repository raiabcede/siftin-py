<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-theme="Green_Theme" class="selected"
	data-layout="vertical" data-boxed-layout="full" data-card="shadow">

	<head>
		@@include("../partials/head.html")
		<title>New Capture - Siftin</title>
	</head>

	<body class="DEFAULT_THEME  bg-white dark:bg-dark">
		<main>
			<!--start the project-->
			<div id="main-wrapper" class="flex">

				<aside id="application-sidebar-brand"
					class="hs-overlay hs-overlay-open:translate-x-0 -translate-x-full xl:rtl:-translate-x-0 rtl:translate-x-full  left-0 rtl:left-auto rtl:right-0 transform hidden xl:block xl:translate-x-0 xl:end-auto xl:bottom-0 fixed top-0 with-vertical  left-sidebar transition-all duration-300 h-screen z-[2] flex-shrink-0 border-r rtl:border-l rtl:border-r-0 w-[270px] border-border dark:border-darkborder bg-white dark:bg-dark">
					@@include("../partials/sidebar.html",{ "page": "sample page 1" })
				</aside>
				<div class="page-wrapper w-full" role="main">
					<!--  Header Start -->
					<header
						class="sticky top-header top-0 inset-x-0 z-[1] flex flex-wrap md:justify-start md:flex-nowrap text-sm bg-white dark:bg-dark ">
					<div
						class="with-vertical w-full">@@include("../partials/header.html")</div>
					<div class="with-horizontal w-full">
						<div class="bg-white dark:bg-dark shadow-md dark:shadow-dark-md">
							<div class="container">
								@@include("../partials/horizontal-header.html")
							</div>
						</div>
					</div>
					</header>
					<!--  Header End -->

					<!-- Horizontal Header Menu -->
					<aside class="with-horizontal lg:flex hidden">
						@@include("../partials/horizontal-sidebar.html", { "page": "sample page 1",
						})
					</aside>
					<!-- Horizontal Header Menu End -->

					<!-- Main Content -->
					<main class="h-full max-w-full pt-6">
						<div class="container full-container py-5">
							<!-- Page Title -->
							<div class="mb-8">
								<div class="flex items-center justify-between mb-2">
									<div>
										<h1 class="text-3xl font-bold text-dark dark:text-white mb-2">New Capture</h1>
										<p class="text-base text-link dark:text-darklink">Create a new LinkedIn lead capture run</p>
									</div>
									<!-- LinkedIn Login Status Indicator -->
									<div id="linkedin-status-indicator" class="flex items-center gap-2 px-4 py-2 rounded-md border border-border dark:border-darkborder bg-white dark:bg-dark transition-shadow" title="Firefox LinkedIn status checker - automatically checks on page load">
										<div id="linkedin-status-icon" class="w-3 h-3 rounded-full bg-gray-400 animate-pulse"></div>
										<span id="linkedin-status-text" class="text-sm text-link dark:text-darklink">Checking status...</span>
									</div>
								</div>
							</div>

							<!-- Step Progress Indicator -->
							<div class="mb-8">
								<div class="flex items-center justify-between">
									<!-- Step 1 -->
									<div class="flex items-center flex-1">
										<div class="flex items-center">
											<div id="step-1-indicator" class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-semibold text-sm">1</div>
											<span id="step-1-label" class="ml-2 text-sm font-medium text-primary">Source</span>
										</div>
										<div id="step-1-line" class="flex-1 h-0.5 bg-gray-200 dark:bg-darkborder mx-4"></div>
									</div>

									<!-- Step 2 -->
									<div class="flex items-center flex-1">
										<div id="step-2-check" class="hidden"><i class="ti ti-check text-primary text-lg"></i></div>
										<div id="step-2-indicator" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-darkborder text-gray-500 dark:text-gray-400 flex items-center justify-center font-semibold text-sm">2</div>
										<span id="step-2-label" class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400">AI Criteria</span>
										<div id="step-2-line" class="flex-1 h-0.5 bg-gray-200 dark:bg-darkborder mx-4"></div>
									</div>

									<!-- Step 3 -->
									<div class="flex items-center flex-1">
										<div id="step-3-check" class="hidden"><i class="ti ti-check text-primary text-lg"></i></div>
										<div id="step-3-indicator" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-darkborder text-gray-500 dark:text-gray-400 flex items-center justify-center font-semibold text-sm">3</div>
										<span id="step-3-label" class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400">Preview & Select</span>
										<div id="step-3-line" class="flex-1 h-0.5 bg-gray-200 dark:bg-darkborder mx-4"></div>
									</div>

									<!-- Step 4 -->
									<div class="flex items-center">
										<div id="step-4-check" class="hidden"><i class="ti ti-check text-primary text-lg"></i></div>
										<div id="step-4-indicator" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-darkborder text-gray-500 dark:text-gray-400 flex items-center justify-center font-semibold text-sm">4</div>
										<span id="step-4-label" class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400">Save & Export</span>
									</div>
								</div>
							</div>

							<!-- Step Content Card -->
							<div class="card shadow-lg">
								<div class="card-body p-8">
									<!-- Step 1: LinkedIn Source -->
									<div id="step-1-content" class="step-content">
										<h2 class="text-2xl font-bold text-dark dark:text-white mb-6">Step 1: LinkedIn Source</h2>
										
										<div class="mb-6">
											<label for="linkedin-url" class="block text-sm font-semibold text-dark dark:text-white mb-2">LinkedIn Search URL</label>
											<input 
												type="text" 
												id="linkedin-url" 
												class="w-full px-4 py-3 border border-border dark:border-darkborder rounded-md bg-white dark:bg-dark text-dark dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" 
												placeholder="https://www.linkedin.com/search/results/people/..."
											/>
										</div>

										<div class="bg-lightinfo dark:bg-darkinfo border-l-4 border-primary p-4 rounded-md mb-6">
											<div class="flex items-start">
												<i class="ti ti-info-circle text-primary text-xl mr-3 mt-0.5"></i>
												<div>
													<p class="text-sm font-semibold text-dark dark:text-white mb-1">Example format:</p>
													<code class="text-xs text-link dark:text-darklink break-all">
														https://www.linkedin.com/search/results/people/?keywords=SDR%20manager&geoUrn=%5B%22103644278%22%5D
													</code>
												</div>
											</div>
										</div>

										<div class="flex justify-end">
											<button id="step1-continue-btn" onclick="nextStep(2)" class="btn btn-primary flex items-center cursor-pointer">
												Continue <i class="ti ti-arrow-right ml-2"></i>
											</button>
										</div>
									</div>

									<!-- Step 2: AI Criteria (Optional) -->
									<div id="step-2-content" class="step-content hidden">
										<h2 class="text-2xl font-bold text-dark dark:text-white mb-6">Step 2: Define AI Criteria (Optional)</h2>
										<p class="text-sm text-link dark:text-darklink mb-4">You can skip this step and extract all profile links, then filter later if needed.</p>
										
										<div class="mb-4">
											<label for="ai-criteria" class="block text-sm font-semibold text-dark dark:text-white mb-2">Describe the leads you want (natural language) - Optional</label>
											<textarea 
												id="ai-criteria" 
												rows="5" 
												class="w-full px-4 py-3 border border-border dark:border-darkborder rounded-md bg-white dark:bg-dark text-dark dark:text-white focus:outline-none focus:ring-2 focus:ring-primary resize-y" 
												placeholder="e.g., US-based SDR managers at B2B SaaS companies with 11-200 employees, preferably using HubSpot or Salesforce..."
											></textarea>
										</div>

										<div class="mb-6">
											<p class="text-sm font-semibold text-dark dark:text-white mb-3">Quick chips (click to insert):</p>
											<div class="flex flex-wrap gap-2">
												<button onclick="insertChip('US-based SDR managers at B2B SaaS (11-200), using HubSpot')" class="px-4 py-2 border border-border dark:border-darkborder text-dark dark:text-white rounded-md text-sm hover:border-primary dark:hover:border-primary transition-colors cursor-pointer">
													US-based SDR managers at B2B SaaS (11-200), using HubSpot
												</button>
												<button onclick="insertChip('Founders in fintech, Series A-B, NYC or remote')" class="px-4 py-2 border border-border dark:border-darkborder text-dark dark:text-white rounded-md text-sm hover:border-primary dark:hover:border-primary transition-colors cursor-pointer">
													Founders in fintech, Series A-B, NYC or remote
												</button>
												<button onclick="insertChip('VP Sales at enterprise software companies (500+ employees)')" class="px-4 py-2 border border-border dark:border-darkborder text-dark dark:text-white rounded-md text-sm hover:border-primary dark:hover:border-primary transition-colors cursor-pointer">
													VP Sales at enterprise software companies (500+ employees)
												</button>
												<button onclick="insertChip('Revenue Operations leaders at high-growth SaaS companies')" class="px-4 py-2 border border-border dark:border-darkborder text-dark dark:text-white rounded-md text-sm hover:border-primary dark:hover:border-primary transition-colors cursor-pointer">
													Revenue Operations leaders at high-growth SaaS companies
												</button>
											</div>
										</div>

										<div class="flex justify-between">
											<button onclick="prevStep(1)" class="btn btn-outline flex items-center cursor-pointer">
												<i class="ti ti-arrow-left mr-2"></i> Back
											</button>
											<button id="step2-preview-btn" onclick="nextStep(3)" class="btn btn-primary flex items-center cursor-pointer">
												Extract Profile Links <i class="ti ti-arrow-right ml-2"></i>
											</button>
										</div>
									</div>

									<!-- Step 3: Preview & Select -->
									<div id="step-3-content" class="step-content hidden">
										<div class="flex justify-between items-center mb-6">
											<h2 class="text-2xl font-bold text-dark dark:text-white">Step 3: Preview & Select Profile Links</h2>
											<div class="flex items-center gap-4">
												<span class="text-sm text-link dark:text-darklink" id="lead-count">0 selected</span>
												<button onclick="selectAll()" class="px-4 py-2 border border-border dark:border-darkborder rounded-md text-sm text-dark dark:text-white hover:bg-primary hover:text-white dark:hover:bg-primary dark:hover:text-white cursor-pointer transition-colors">Select All</button>
												<button onclick="deselectAll()" class="px-4 py-2 border border-border dark:border-darkborder rounded-md text-sm text-dark dark:text-white hover:bg-primary hover:text-white dark:hover:bg-primary dark:hover:text-white cursor-pointer transition-colors">Deselect All</button>
											</div>
										</div>

										<div class="space-y-4 max-h-[600px] overflow-y-auto" id="leads-list">
											<!-- Leads will be dynamically inserted here -->
										</div>
										
										<!-- Mock Data Notice -->
										<div id="mock-data-notice" class="hidden mt-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md p-4">
											<div class="flex items-start">
												<i class="ti ti-info-circle text-blue-600 dark:text-blue-400 text-lg mr-3 mt-0.5"></i>
												<div>
													<p class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-1">Dynamic Lead Generation</p>
													<p class="text-xs text-blue-700 dark:text-blue-300">Leads are generated dynamically based on your LinkedIn URL and AI criteria. In production, this would fetch real LinkedIn profiles.</p>
												</div>
											</div>
										</div>

										<div class="flex justify-between mt-6">
											<button onclick="prevStep(2)" class="btn btn-outline flex items-center cursor-pointer">
												<i class="ti ti-arrow-left mr-2"></i> Back
											</button>
											<button onclick="nextStep(4)" class="btn btn-primary flex items-center cursor-pointer" id="save-selection-btn" disabled>
												Save Selection <i class="ti ti-arrow-right ml-2"></i>
											</button>
										</div>
									</div>

									<!-- Step 4: Save & Export -->
									<div id="step-4-content" class="step-content hidden">
										<h2 class="text-2xl font-bold text-dark dark:text-white mb-6">Step 4: Save & Export</h2>
										
										<div class="mb-6">
											<label for="run-label" class="block text-sm font-semibold text-dark dark:text-white mb-2">Run Label</label>
											<input 
												type="text" 
												id="run-label" 
												class="w-full px-4 py-3 border border-border dark:border-darkborder rounded-md bg-white dark:bg-dark text-dark dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" 
												value="Run - 10/31/2025 2:15:07 PM"
											/>
										</div>

										<div class="card bg-lightsecondary dark:bg-darksecondary mb-6">
											<div class="card-body">
												<h5 class="font-semibold text-dark dark:text-white mb-4">Summary</h5>
												<div class="space-y-2 text-sm">
													<div class="flex">
														<span class="text-link dark:text-darklink w-32">Source:</span>
														<span class="text-dark dark:text-white flex-1 break-all" id="summary-source">-</span>
													</div>
													<div class="flex">
														<span class="text-link dark:text-darklink w-32">Keywords:</span>
														<span class="text-dark dark:text-white flex-1" id="summary-keywords">-</span>
													</div>
													<div class="flex">
														<span class="text-link dark:text-darklink w-32">Criteria:</span>
														<span class="text-dark dark:text-white flex-1" id="summary-criteria">-</span>
													</div>
													<div class="flex">
														<span class="text-link dark:text-darklink w-32">Found:</span>
														<span class="text-dark dark:text-white flex-1" id="summary-found">-</span>
													</div>
													<div class="flex">
														<span class="text-link dark:text-darklink w-32">Selected:</span>
														<span class="text-dark dark:text-white flex-1" id="summary-selected">-</span>
													</div>
												</div>
											</div>
										</div>

										<div class="flex justify-between">
											<button onclick="prevStep(3)" class="btn btn-outline flex items-center cursor-pointer">
												<i class="ti ti-arrow-left mr-2"></i> Back
											</button>
											<div class="flex gap-3">
												<button onclick="saveToLibrary()" class="btn btn-outline flex items-center cursor-pointer">
													<i class="ti ti-file-text mr-2"></i> Save to Leads Library
												</button>
												<button onclick="saveAndExport()" class="btn btn-primary flex items-center cursor-pointer">
													<i class="ti ti-download mr-2"></i> Save & Export...
												</button>
											</div>
										</div>
									</div>

								</div>
							</div>

						</div>

					</main>
					<!-- Main Content End -->

				</div>
			</div>
			<!--end of project-->
		</main>
		@@include("../partials/header-components/mobile-menu.html")
		@@include("../partials/header-components/dd-searchbar.html")
		@@include("../partials/header-components/dd-cart.html")
		@@include("../partials/customizer.html")
		@@include("../partials/scripts.html")
		
		<script>
			// API Configuration
			const API_BASE_URL = 'http://localhost:8000';
			
			// Application state
			let currentStep = 1;
			let selectedLeads = [];
			let foundLeads = [];
			let extractedLinks = []; // Store extracted profile links
			let linkedinUrl = '';
			let aiCriteria = '';
			let extractedKeywords = '';
			let linkedinLoginStatus = null;
			
			// Helper function for API calls
			async function apiCall(endpoint, method = 'GET', data = null, timeout = 300000) {
				// Default timeout: 5 minutes (300000ms) for find-leads endpoint
				// Other endpoints use default or can specify custom timeout
				try {
					const options = {
						method,
						headers: {
							'Content-Type': 'application/json',
						}
					};
					
					if (data) {
						options.body = JSON.stringify(data);
					}
					
					console.log(`[API] Calling ${method} ${API_BASE_URL}${endpoint}`, data);
					
					// Create a timeout promise
					const timeoutPromise = new Promise((_, reject) => {
						setTimeout(() => {
							reject(new Error(`Request timeout after ${timeout / 1000} seconds. The scraper may be waiting for LinkedIn login.`));
						}, timeout);
					});
					
					// Race between fetch and timeout
					const response = await Promise.race([
						fetch(`${API_BASE_URL}${endpoint}`, options),
						timeoutPromise
					]);
					
					if (!response.ok) {
						const error = await response.json().catch(() => ({ detail: 'Unknown error' }));
						console.error(`[API] Error response:`, error);
						throw new Error(error.detail || `HTTP error! status: ${response.status}`);
					}
					
					const result = await response.json();
					console.log(`[API] Success:`, result);
					return result;
				} catch (error) {
					console.error('[API] Request failed:', error);
					
					// Check if it's a network error (API not running)
					if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
						throw new Error('Cannot connect to API. Make sure the FastAPI server is running on http://localhost:8000');
					}
					
					throw error;
				}
			}
			
			// Show loading state
			function showLoading(elementId, show = true) {
				const element = document.getElementById(elementId);
				if (!element) return;
				
				if (show) {
					element.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div><p class="mt-4 text-link dark:text-darklink">Loading...</p></div>';
				} else {
					// Clear loading state - let the caller set the content
					element.innerHTML = '';
				}
			}
			
			// Show error message
			function showError(message) {
				alert(`Error: ${message}`);
			}

			function updateStepIndicator(step) {
				// Reset all steps
				for (let i = 1; i <= 4; i++) {
					const indicator = document.getElementById(`step-${i}-indicator`);
					const label = document.getElementById(`step-${i}-label`);
					const check = document.getElementById(`step-${i}-check`);
					const line = document.getElementById(`step-${i}-line`);
					const content = document.getElementById(`step-${i}-content`);

					if (!indicator || !label) continue;

					if (i < step) {
						// Completed steps
						indicator.classList.add('hidden');
						if (check) check.classList.remove('hidden');
						label.classList.remove('text-gray-500', 'dark:text-gray-400');
						label.classList.add('text-primary');
						if (line) line.classList.remove('bg-gray-200', 'dark:bg-darkborder');
						if (line) line.classList.add('bg-primary');
						if (content) content.classList.add('hidden');
					} else if (i === step) {
						// Current step
						indicator.classList.remove('hidden', 'bg-gray-200', 'dark:bg-darkborder', 'text-gray-500', 'dark:text-gray-400');
						indicator.classList.add('bg-primary', 'text-white');
						if (check) check.classList.add('hidden');
						label.classList.remove('text-gray-500', 'dark:text-gray-400');
						label.classList.add('text-primary');
						if (content) content.classList.remove('hidden');
					} else {
						// Future steps
						indicator.classList.remove('bg-primary', 'text-white');
						indicator.classList.add('bg-gray-200', 'dark:bg-darkborder', 'text-gray-500', 'dark:text-gray-400');
						if (check) check.classList.add('hidden');
						label.classList.remove('text-primary');
						label.classList.add('text-gray-500', 'dark:text-gray-400');
						if (line) line.classList.remove('bg-primary');
						if (line) line.classList.add('bg-gray-200', 'dark:bg-darkborder');
						if (content) content.classList.add('hidden');
					}
				}
			}

			// Extract keywords from LinkedIn URL (client-side, instant)
			function extractKeywordsFromUrl(url) {
				try {
					const urlObj = new URL(url);
					const params = new URLSearchParams(urlObj.search);
					
					// Try to get keywords from query parameter
					let keywords = params.get('keywords') || '';
					
					// If no keywords in query, try to extract from URL path
					if (!keywords) {
						const pathParts = urlObj.pathname.split('/');
						for (const part of pathParts) {
							if (part && part !== 'search' && part !== 'results' && part !== 'people') {
								// Decode URL encoding
								const decoded = decodeURIComponent(part);
								if (decoded && decoded.length > 2) {
									keywords = decoded.replace(/-/g, ' ').replace(/_/g, ' ');
									break;
								}
							}
						}
					}
					
					return keywords || 'LinkedIn Search';
				} catch (error) {
					console.error('Error extracting keywords:', error);
					return 'LinkedIn Search';
				}
			}

			async function nextStep(step) {
				if (step === 2) {
					// Validate LinkedIn URL before proceeding
					const urlInput = document.getElementById('linkedin-url');
					linkedinUrl = urlInput?.value?.trim() || '';
					
					if (!linkedinUrl) {
						showError('Please enter a LinkedIn search URL');
						return;
					}
					
					// Validate URL format
					try {
						new URL(linkedinUrl);
					} catch (error) {
						showError('Please enter a valid LinkedIn URL');
						return;
					}
					
					// Validate that it's a search results URL (not a profile URL like /me or /in/)
					if (!linkedinUrl.includes('/search/results/people')) {
						showError('Please enter a LinkedIn search results URL. The URL must contain "/search/results/people". Example: https://www.linkedin.com/search/results/people/?keywords=...');
						console.error('[Step 1] Invalid URL format. Expected search results URL, got:', linkedinUrl);
						return;
					}
					
					// Extract keywords client-side (instant, no API call needed)
					extractedKeywords = extractKeywordsFromUrl(linkedinUrl);
					
					// Step 1 is now instant - proceed immediately
				}
				
				if (step === 3) {
					// Step 3: Extract profile links (AI criteria is optional, stored for later use)
					const criteriaInput = document.getElementById('ai-criteria');
					aiCriteria = criteriaInput?.value?.trim() || '';
					
					if (!linkedinUrl) {
						showError('LinkedIn URL is required. Please go back to step 1.');
						return;
					}
					
					// Get button reference (declare once for the entire block)
					const previewBtn = document.getElementById('step2-preview-btn');
					const originalBtnText = previewBtn?.innerHTML || '';
					
					try {
						// Show loading state
						if (previewBtn) {
							previewBtn.disabled = true;
							previewBtn.innerHTML = '<span class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></span>Extracting links...';
						}
						
						// Update step indicator first to show step 3
						currentStep = step;
						updateStepIndicator(step);
						
						showLoading('leads-list', true);
						
						// Double-check URL is a search URL
						if (!linkedinUrl || !linkedinUrl.includes('/search/results/people')) {
							showLoading('leads-list', false);
							if (previewBtn) {
								previewBtn.disabled = false;
								previewBtn.innerHTML = originalBtnText;
							}
							showError('Invalid LinkedIn URL. Please provide a LinkedIn search results URL (must contain "/search/results/people"). Profile URLs like /me or /in/ are not supported.');
							console.error('[Step 3] Invalid URL format. Expected search results URL, got:', linkedinUrl);
							return;
						}
						
						console.log('[Step 3] Extracting profile links from:', linkedinUrl);
						
						// Show a message that this may take a while
						const leadsList = document.getElementById('leads-list');
						if (leadsList) {
							leadsList.innerHTML = `
								<div class="text-center py-8">
									<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md p-6 mb-4">
										<div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 dark:border-blue-400 mb-4"></div>
										<h3 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-2">Extracting Profile Links...</h3>
										<p class="text-sm text-blue-700 dark:text-blue-300 mb-2">
											This may take 1-3 minutes. The browser will open automatically for LinkedIn login if needed.
										</p>
										<p class="text-xs text-blue-600 dark:text-blue-400">
											Please wait and check the browser window that opens.
										</p>
									</div>
								</div>
							`;
						}
						
						// Use extract-links endpoint instead of find-leads
						// Use longer timeout for extraction (5 minutes)
						const result = await apiCall('/api/capture/extract-links', 'POST', {
							linkedin_url: linkedinUrl,
							max_results: 100,
							max_pages: 10
						}, 300000); // 5 minutes timeout
						
						console.log('[Step 3] API response received:', result);
						
						if (!result) {
							throw new Error('Invalid response from API');
						}
						
						if (!result.success) {
							throw new Error(result.errors?.[0] || 'Failed to extract profile links');
						}
						
						// Extract links from response
						extractedLinks = result.links || [];
						console.log('[Step 3] Extracted links:', extractedLinks.length);
						
						// Convert links to lead format for display
						foundLeads = extractedLinks.map((link, index) => {
							// Extract profile ID from URL
							const profileId = link.split('/in/')[1]?.split('?')[0]?.split('/')[0] || `profile-${index}`;
							return {
								id: profileId,
								name: profileId.replace(/-/g, ' '), // Use profile ID as placeholder name
								title: '',
								company: '',
								location: '',
								match_score: 0,
								description: '',
								linkedin_url: link,
								email: null,
								profile_image: null,
								created_at: new Date().toISOString(),
								is_mock: false
							};
						});
						
						// Hide loading spinner
						showLoading('leads-list', false);
						
						if (foundLeads.length === 0) {
							generateLeadsList(); // This will show "No leads found"
							document.getElementById('mock-data-notice')?.classList.add('hidden');
						} else {
							// Update count immediately
							updateLeadCount();
							generateLeadsList();
							// Hide mock data notice since these are real links
							document.getElementById('mock-data-notice')?.classList.add('hidden');
						}
						
						// Restore button
						if (previewBtn) {
							previewBtn.disabled = false;
							previewBtn.innerHTML = originalBtnText;
						}
					} catch (error) {
						console.error('[Step 3] Error:', error);
						showLoading('leads-list', false);
						
						// Restore button state immediately (previewBtn already declared above)
						if (previewBtn) {
							previewBtn.disabled = false;
							previewBtn.innerHTML = 'Find Leads <i class="ti ti-search ml-2"></i>';
						}
						
						// Show error message in leads list
						const leadsList = document.getElementById('leads-list');
						if (leadsList) {
							let errorMessage = error.message || 'Unknown error occurred';
							
							// Handle timeout specifically
							if (errorMessage.includes('timeout') || errorMessage.includes('Request timeout')) {
								leadsList.innerHTML = `
									<div class="text-center py-8">
										<div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md p-6 mb-4">
											<i class="ti ti-clock text-yellow-600 dark:text-yellow-400 text-4xl mb-4"></i>
											<h3 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-2">Request Timed Out</h3>
											<p class="text-sm text-yellow-700 dark:text-yellow-300 mb-4">
												The request took too long. This usually means:
											</p>
											<ul class="text-sm text-yellow-700 dark:text-yellow-300 text-left max-w-md mx-auto space-y-2 mb-4">
												<li>• A browser window opened - please log into LinkedIn there</li>
												<li>• The scraper is waiting for you to complete login</li>
												<li>• LinkedIn may be blocking automated access</li>
											</ul>
											<p class="text-xs text-yellow-600 dark:text-yellow-400 mb-4">
												Check if a Chrome browser window opened. Log in to LinkedIn if needed, then try again.
											</p>
											<button onclick="nextStep(3)" class="btn btn-primary mt-4">Try Again</button>
										</div>
									</div>
								`;
								showError('Request timed out. Please check if a browser window opened and try again.');
							} else if (errorMessage.includes('Unable to fetch LinkedIn profiles') || errorMessage.includes('404')) {
								leadsList.innerHTML = `
									<div class="text-center py-8">
										<div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md p-6 mb-4">
											<i class="ti ti-alert-circle text-yellow-600 dark:text-yellow-400 text-4xl mb-4"></i>
											<h3 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-2">No LinkedIn Profiles Found</h3>
											<p class="text-sm text-yellow-700 dark:text-yellow-300 mb-4">
												Unable to fetch LinkedIn profiles from the search URL. Please ensure:
											</p>
											<ul class="text-sm text-yellow-700 dark:text-yellow-300 text-left max-w-md mx-auto space-y-2">
												<li>• You are logged into LinkedIn</li>
												<li>• The search URL is valid and accessible</li>
												<li>• ChromeDriver is installed (for automated scraping)</li>
											</ul>
										</div>
									</div>
								`;
							} else {
								leadsList.innerHTML = `
									<div class="text-center py-8">
										<p class="text-red-500 dark:text-red-400 mb-2 font-semibold">Error loading leads</p>
										<p class="text-sm text-link dark:text-darklink">${errorMessage}</p>
									</div>
								`;
							}
						}
						// Restore button (previewBtn already declared above)
						if (previewBtn) {
							previewBtn.disabled = false;
							previewBtn.innerHTML = 'Preview Matches <i class="ti ti-arrow-right ml-2"></i>';
						}
						return;
					}
				}
				
				if (step === 4) {
					// Update summary when moving to step 4
					updateSummary();
				}
				
				// Only update step indicator if we're not in step 3 (it's already updated there)
				if (step !== 3) {
					currentStep = step;
					updateStepIndicator(step);
				}
			}

			function prevStep(step) {
				currentStep = step;
				updateStepIndicator(step);
			}

			function insertChip(text) {
				const textarea = document.getElementById('ai-criteria');
				if (!textarea) return;
				const currentText = textarea.value;
				textarea.value = currentText ? currentText + ' ' + text : text;
				textarea.focus();
			}

			function generateLeadsList() {
				const leadsList = document.getElementById('leads-list');
				if (!leadsList) return;
				leadsList.innerHTML = '';
				selectedLeads = [];

				if (foundLeads.length === 0) {
					leadsList.innerHTML = '<div class="text-center py-8 text-link dark:text-darklink">No leads found</div>';
					updateLeadCount();
					return;
				}

				console.log('[generateLeadsList] Rendering', foundLeads.length, 'leads with lazy loading');

				// Map user images (cycling through available profile images)
				const userImages = [
					'@@webRoot/assets/images/profile/user-1.jpg',
					'@@webRoot/assets/images/profile/user-2.jpg',
					'@@webRoot/assets/images/profile/user-3.jpg',
					'@@webRoot/assets/images/profile/user-4.jpg',
					'@@webRoot/assets/images/profile/user-5.jpg',
					'@@webRoot/assets/images/profile/user-6.jpg',
					'@@webRoot/assets/images/profile/user-7.jpg',
					'@@webRoot/assets/images/profile/user-8.jpg'
				];

				// Lazy load leads one by one
				let currentIndex = 0;
				const delayBetweenLeads = 150; // milliseconds between each lead

				function showNextLead() {
					if (currentIndex >= foundLeads.length) {
						// All leads shown, update count
						updateLeadCount();
						return;
					}

					const lead = foundLeads[currentIndex];
					const leadCard = document.createElement('div');
					leadCard.className = 'card border border-border dark:border-darkborder hover:border-primary transition-colors opacity-0 translate-y-4';
					leadCard.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
					
					const imageIndex = currentIndex % userImages.length;
					const matchScore = lead.match_score || 0;
					// Use profile_image if available, otherwise fall back to local images
					const profileImage = lead.profile_image || userImages[imageIndex];
					// Make name clickable with LinkedIn URL
					const nameLink = lead.linkedin_url 
						? `<a href="${lead.linkedin_url}" target="_blank" rel="noopener noreferrer" class="font-semibold text-dark dark:text-white hover:text-primary transition-colors">${lead.name}</a>`
						: `<span class="font-semibold text-dark dark:text-white">${lead.name}</span>`;
					leadCard.innerHTML = `
						<div class="card-body p-4">
							<div class="flex items-start gap-4">
								<input type="checkbox" class="mt-2 lead-checkbox cursor-pointer" data-lead-id="${lead.id}" onchange="toggleLead('${lead.id}')">
								<img src="${profileImage}" alt="${lead.name}" class="w-12 h-12 rounded-full object-cover" onerror="this.src='${userImages[imageIndex]}'">
								<div class="flex-1">
									<div class="flex items-center gap-2 mb-1">
										<h5>${nameLink}</h5>
										<span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded text-xs font-semibold">${matchScore}%</span>
									</div>
									<p class="text-sm text-link dark:text-darklink mb-1">${lead.title} at ${lead.company}</p>
									<p class="text-sm text-dark dark:text-white mb-1">${lead.description || ''}</p>
									<p class="text-sm text-link dark:text-darklink">${lead.location || ''}</p>
								</div>
							</div>
						</div>
					`;
					
					leadsList.appendChild(leadCard);
					
					// Trigger animation by changing opacity and transform
					setTimeout(() => {
						leadCard.style.opacity = '1';
						leadCard.style.transform = 'translateY(0)';
					}, 10); // Small delay to ensure DOM is ready
					
					currentIndex++;
					
					// Schedule next lead
					setTimeout(showNextLead, delayBetweenLeads);
				}

				// Start showing leads
				showNextLead();
			}

			function toggleLead(leadId) {
				const index = selectedLeads.indexOf(leadId);
				if (index > -1) {
					selectedLeads.splice(index, 1);
				} else {
					selectedLeads.push(leadId);
				}
				updateLeadCount();
			}

			function selectAll() {
				selectedLeads = foundLeads.map(lead => lead.id);
				document.querySelectorAll('.lead-checkbox').forEach(cb => cb.checked = true);
				updateLeadCount();
			}

			function deselectAll() {
				selectedLeads = [];
				document.querySelectorAll('.lead-checkbox').forEach(cb => cb.checked = false);
				updateLeadCount();
			}

			function updateLeadCount() {
				const count = selectedLeads.length;
				const leadCountEl = document.getElementById('lead-count');
				const saveBtn = document.getElementById('save-selection-btn');
				if (leadCountEl) leadCountEl.textContent = `${foundLeads.length} found • ${count} selected`;
				if (saveBtn) saveBtn.disabled = count === 0;
			}

			function updateSummary() {
				const runLabelInput = document.getElementById('run-label');
				const summarySource = document.getElementById('summary-source');
				const summaryKeywords = document.getElementById('summary-keywords');
				const summaryCriteria = document.getElementById('summary-criteria');
				const summaryFound = document.getElementById('summary-found');
				const summarySelected = document.getElementById('summary-selected');
				
				// Set default run label if empty
				if (runLabelInput && !runLabelInput.value) {
					const now = new Date();
					runLabelInput.value = `Run - ${now.toLocaleString()}`;
				}
				
				if (summarySource) summarySource.textContent = linkedinUrl || '-';
				if (summaryKeywords) summaryKeywords.textContent = extractedKeywords || '-';
				if (summaryCriteria) summaryCriteria.textContent = aiCriteria || '-';
				if (summaryFound) summaryFound.textContent = `${foundLeads.length} leads`;
				if (summarySelected) summarySelected.textContent = `${selectedLeads.length} leads`;
			}

			async function saveToLibrary() {
				if (selectedLeads.length === 0) {
					showError('Please select at least one lead');
					return;
				}
				
				const runLabelInput = document.getElementById('run-label');
				const runLabel = runLabelInput?.value || `Run - ${new Date().toLocaleString()}`;
				
				try {
					const result = await apiCall('/api/capture/save-to-library', 'POST', {
						linkedin_url: linkedinUrl,
						ai_criteria: aiCriteria,
						run_label: runLabel,
						selected_lead_ids: selectedLeads
					});
					
					alert(`Success! ${result.message}`);
				} catch (error) {
					showError(error.message);
				}
			}

			async function saveAndExport() {
				if (selectedLeads.length === 0) {
					showError('Please select at least one lead');
					return;
				}
				
				const runLabelInput = document.getElementById('run-label');
				const runLabel = runLabelInput?.value || `Run - ${new Date().toLocaleString()}`;
				
				try {
					// Get full lead data for selected leads
					const selectedLeadData = foundLeads.filter(lead => selectedLeads.includes(lead.id));
					
					if (selectedLeadData.length === 0) {
						showError('No lead data found for selected leads');
						return;
					}
					
					// Save the run
					const saveResult = await apiCall('/api/capture/save-run', 'POST', {
						linkedin_url: linkedinUrl,
						ai_criteria: aiCriteria,
						run_label: runLabel,
						selected_lead_ids: selectedLeads
					});
					
					// Export the leads with full lead data
					const exportResult = await apiCall('/api/capture/export', 'POST', {
						linkedin_url: linkedinUrl,
						ai_criteria: aiCriteria,
						run_label: runLabel,
						selected_lead_ids: selectedLeads,
						leads: selectedLeadData  // Send full lead objects
					});
					
					alert(`Success! ${saveResult.message}. ${exportResult.message}`);
					
					// Trigger download if download URL is provided
					if (exportResult.download_url) {
						window.location.href = `${API_BASE_URL}${exportResult.download_url}`;
					}
				} catch (error) {
					showError(error.message);
				}
			}

			// Check LinkedIn login status
			async function checkLinkedInStatus() {
				const statusIndicator = document.getElementById('linkedin-status-indicator');
				const statusIcon = document.getElementById('linkedin-status-icon');
				const statusText = document.getElementById('linkedin-status-text');
				
				if (!statusIndicator || !statusIcon || !statusText) return;
				
				// Check if we're returning from LinkedIn (legacy support)
				const urlParams = new URLSearchParams(window.location.search);
				const fromLinkedIn = urlParams.get('fromLinkedIn');
				
				if (fromLinkedIn === 'true') {
					// We just returned from LinkedIn, check status via API
					// Remove the parameter from URL
					urlParams.delete('fromLinkedIn');
					const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
					window.history.replaceState({}, '', newUrl);
					
					// Show checking state
					statusIcon.className = 'w-3 h-3 rounded-full bg-gray-400 animate-pulse';
					statusText.textContent = 'Checking...';
					statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-border dark:border-darkborder bg-white dark:bg-dark';
					statusText.className = 'text-sm text-link dark:text-darklink';
					
					try {
						// Check status via API
						const url = '/api/linkedin-login-status';
						const timeout = 50000;
						const result = await apiCall(url, 'GET', null, timeout);
						await updateStatusFromResult(result, statusIndicator, statusIcon, statusText);
						return;
					} catch (error) {
						console.error('[Frontend] Error checking status after LinkedIn redirect:', error);
						statusIcon.className = 'w-3 h-3 rounded-full bg-red-500';
						statusText.textContent = 'Error checking status';
						statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20';
						statusText.className = 'text-sm text-red-700 dark:text-red-300 font-medium';
						return;
					}
				}
				
				// Open LinkedIn in a popup window to check/login
				// Show opening state
				statusIcon.className = 'w-3 h-3 rounded-full bg-blue-500 animate-pulse';
				statusText.textContent = 'Opening LinkedIn...';
				statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20';
				statusText.className = 'text-sm text-blue-700 dark:text-blue-300 font-medium';
				
				// Open popup window
				const popupWidth = 800;
				const popupHeight = 600;
				const left = (window.screen.width - popupWidth) / 2;
				const top = (window.screen.height - popupHeight) / 2;
				
				const popup = window.open(
					'https://www.linkedin.com/feed/',
					'linkedinLogin',
					`width=${popupWidth},height=${popupHeight},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
				);
				
				if (!popup) {
					// Popup blocked
					statusIcon.className = 'w-3 h-3 rounded-full bg-red-500';
					statusText.textContent = 'Popup blocked - please allow popups';
					statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20';
					statusText.className = 'text-sm text-red-700 dark:text-red-300 font-medium';
					alert('Please allow popups for this site, then try again.');
					return;
				}
				
				// Update status
				statusText.textContent = 'Checking if logged in...';
				
				// Function to check authentication status
				const checkAuthStatus = async (closePopupIfLoggedIn = false) => {
					statusIcon.className = 'w-3 h-3 rounded-full bg-gray-400 animate-pulse';
					statusText.textContent = 'Checking authentication...';
					
					try {
						const url = '/api/linkedin-login-status';
						const timeout = 50000;
						const result = await apiCall(url, 'GET', null, timeout);
						
						// If user is logged in and we should close popup, close it
						if (closePopupIfLoggedIn && result && result.logged_in === true && !popup.closed) {
							popup.close();
							statusText.textContent = 'Already logged in - closing popup...';
						}
						
						await updateStatusFromResult(result, statusIndicator, statusIcon, statusText);
					} catch (error) {
						console.error('[Frontend] Error checking status:', error);
						statusIcon.className = 'w-3 h-3 rounded-full bg-red-500';
						statusText.textContent = 'Error checking status';
						statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20';
						statusText.className = 'text-sm text-red-700 dark:text-red-300 font-medium';
					}
				};
				
				// Check authentication status immediately to see if already logged in
				setTimeout(() => {
					checkAuthStatus(true); // Pass true to close popup if logged in
				}, 2000); // Wait 2 seconds for popup to load
				
				// Poll the popup to check if it's closed and also check auth status periodically
				let authCheckCount = 0;
				const checkPopup = setInterval(async () => {
					try {
						// Check if popup is closed
						if (popup.closed) {
							clearInterval(checkPopup);
							// Popup was closed, check authentication status
							// Small delay to ensure cookies are saved
							setTimeout(() => checkAuthStatus(false), 1000);
							return;
						}
						
						// Try to check popup URL (may fail due to cross-origin restrictions)
						try {
							const popupUrl = popup.location.href;
							// If we can access the URL and it's the feed, user is logged in
							if (popupUrl && popupUrl.includes('linkedin.com/feed')) {
								// User is logged in! Close popup and check status
								clearInterval(checkPopup);
								if (!popup.closed) {
									popup.close();
								}
								statusText.textContent = 'Logged in - checking status...';
								setTimeout(() => checkAuthStatus(false), 1000);
								return;
							}
						} catch (e) {
							// Cross-origin error - can't access popup URL, that's normal
							// We'll use periodic API checks instead
						}
						
						// Periodically check if user is logged in (every 10 seconds)
						// If logged in, close popup automatically
						authCheckCount++;
						if (authCheckCount % 20 === 0) { // Every 10 seconds (20 * 500ms)
							try {
								const url = '/api/linkedin-login-status';
								const timeout = 35000; // 35 seconds - API can take up to 30 seconds
								const result = await apiCall(url, 'GET', null, timeout);
								
								if (result && result.logged_in === true && !popup.closed) {
									// User is logged in! Close popup and check full status
									clearInterval(checkPopup);
									popup.close();
									statusText.textContent = 'Logged in - checking status...';
									setTimeout(() => checkAuthStatus(false), 1000);
								}
							} catch (error) {
								// Ignore timeout errors in periodic checks - they're expected while waiting
								// Only log if it's not a timeout error
								if (!error.message || !error.message.includes('timeout')) {
									console.log('[Frontend] Periodic auth check error (ignored):', error.message);
								}
							}
						}
					} catch (error) {
						console.error('[Frontend] Error checking popup:', error);
					}
				}, 500); // Check every 500ms
				
				// Stop checking after 10 minutes and close popup if still open
				setTimeout(() => {
					clearInterval(checkPopup);
					if (!popup.closed) {
						popup.close();
					}
					// Check status anyway
					setTimeout(() => checkAuthStatus(false), 1000);
				}, 600000); // 10 minutes
			}
			
			// Helper function to update status UI from API result
			async function updateStatusFromResult(result, statusIndicator, statusIcon, statusText) {
				linkedinLoginStatus = result.logged_in;
				
				try {
					if (result.status === 'success') {
						if (result.logged_in === true && result.brightdata_configured) {
							// BrightData API configured and ready
							statusIcon.className = 'w-3 h-3 rounded-full bg-green-500';
							// Show user name if available
							const displayText = result.user_name 
								? `LinkedIn: ${result.user_name}` 
								: (result.message || 'LinkedIn: Logged In (Firefox)');
							statusText.textContent = displayText;
							statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20';
							statusText.className = 'text-sm text-green-700 dark:text-green-300 font-medium';
							const tooltip = result.user_name 
								? `Logged in as ${result.user_name} (Firefox) - Ready to capture leads`
								: ((result.note || result.suggestion || 'LinkedIn authentication verified via Firefox profile').trim());
							statusIndicator.title = tooltip || 'LinkedIn: Logged In (Firefox) - Ready to capture leads';
							
							// Make status indicator clickable to open BrightData dashboard
							if (result.brightdata_dashboard_url) {
								statusIndicator.style.cursor = 'pointer';
								statusIndicator.onclick = (e) => {
									e.stopPropagation();
									window.open(result.brightdata_dashboard_url, '_blank');
								};
								statusIndicator.title = (tooltip || 'BrightData API is configured') + ' (Click to open BrightData Dashboard)';
							}
						} else if (result.logged_in === true) {
							// Logged in but BrightData not configured
							statusIcon.className = 'w-3 h-3 rounded-full bg-green-500';
							// Show user name if available
							const displayText = result.user_name 
								? `LinkedIn: ${result.user_name}` 
								: (result.message || 'LinkedIn: Logged In (Firefox)');
							statusText.textContent = displayText;
							statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20';
							statusText.className = 'text-sm text-green-700 dark:text-green-300 font-medium';
							const tooltip = result.user_name 
								? `Logged in as ${result.user_name} (Firefox)`
								: ((result.note || result.suggestion || 'LinkedIn authentication verified via Firefox profile').trim());
							statusIndicator.title = tooltip || 'LinkedIn: Logged In (Firefox)';
							statusIndicator.style.cursor = 'default';
							statusIndicator.onclick = null;
						} else {
							// BrightData not configured
							statusIcon.className = 'w-3 h-3 rounded-full bg-yellow-500';
							statusText.textContent = result.message || 'BrightData: Not Configured';
							statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-yellow-200 dark:border-yellow-800 bg-yellow-50 dark:bg-yellow-900/20';
							statusText.className = 'text-sm text-yellow-700 dark:text-yellow-300 font-medium';
							const tooltip = (result.note || result.suggestion || '').trim();
							statusIndicator.title = tooltip || 'Configure BrightData API credentials';
							
							// Make clickable to open BrightData dashboard
							if (result.brightdata_dashboard_url) {
								statusIndicator.style.cursor = 'pointer';
								statusIndicator.onclick = (e) => {
									e.stopPropagation();
									window.open(result.brightdata_dashboard_url, '_blank');
								};
							}
						}
					} else if (result.status === 'error') {
						// Error state - check if it's authentication error
						if (result.logged_in === false) {
							// Authentication required - Firefox profile not logged in
							statusIcon.className = 'w-3 h-3 rounded-full bg-red-500';
							statusText.textContent = result.message || 'LinkedIn: Not Logged In (Firefox)';
							statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20';
							statusText.className = 'text-sm text-red-700 dark:text-red-300 font-medium';
							const tooltip = (result.note || result.error || result.suggestion || 'Please log in to LinkedIn in your Firefox profile. The status checker uses Firefox to verify authentication.').trim();
							statusIndicator.title = tooltip || 'LinkedIn authentication required - Please log in to LinkedIn in your Firefox profile';
							statusIndicator.style.cursor = 'default';
							statusIndicator.onclick = null;
						} else {
							// Other error - BrightData not configured
							statusIcon.className = 'w-3 h-3 rounded-full bg-yellow-500';
							statusText.textContent = result.message || 'BrightData: Configuration Needed';
							statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-yellow-200 dark:border-yellow-800 bg-yellow-50 dark:bg-yellow-900/20';
							statusText.className = 'text-sm text-yellow-700 dark:text-yellow-300 font-medium';
							const tooltip = (result.note || result.suggestion || '').trim();
							statusIndicator.title = tooltip || 'Set BRIGHTDATA_API_TOKEN and BRIGHTDATA_COLLECTOR_ID in api/.env';
							
							// Make clickable
							if (result.brightdata_dashboard_url) {
								statusIndicator.style.cursor = 'pointer';
								statusIndicator.onclick = (e) => {
									e.stopPropagation();
									window.open(result.brightdata_dashboard_url, '_blank');
								};
							}
						}
					} else {
						// Info or unknown state
						statusIcon.className = 'w-3 h-3 rounded-full bg-blue-500';
						statusText.textContent = result.message || 'BrightData: Checking...';
						statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20';
						statusText.className = 'text-sm text-blue-700 dark:text-blue-300 font-medium';
						const tooltip = (result.note || result.suggestion || '').trim();
						statusIndicator.title = tooltip || 'BrightData API status';
					}
				} catch (error) {
					console.error('[Status Check] Error:', error);
					
					// Check if it's a connection error (API server not running)
					const isConnectionError = error.message && (
						error.message.includes('Cannot connect to API') ||
						error.message.includes('Failed to fetch') ||
						error.message.includes('ERR_CONNECTION_REFUSED') ||
						error.message.includes('NetworkError')
					);
					
					if (isConnectionError) {
						// Connection error - API server not running
						statusIcon.className = 'w-3 h-3 rounded-full bg-orange-500';
						statusText.textContent = 'API Server: Not Running';
						statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-orange-200 dark:border-orange-800 bg-orange-50 dark:bg-orange-900/20';
						statusText.className = 'text-sm text-orange-700 dark:text-orange-300 font-medium';
						statusIndicator.title = 'FastAPI server is not running. Please start the server by running: cd api && python main.py (or uvicorn main:app --reload)';
					} else {
						// Other error state
						statusIcon.className = 'w-3 h-3 rounded-full bg-red-500';
						statusText.textContent = 'Status: Check Failed';
						statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20';
						statusText.className = 'text-sm text-red-700 dark:text-red-300 font-medium';
						statusIndicator.title = error.message || 'Failed to check login status. Check console for details.';
					}
				}
			}
			
			// Check LinkedIn login status automatically on page load using Firefox (optimized)
			async function checkLinkedInStatusOnLoad() {
				const statusIndicator = document.getElementById('linkedin-status-indicator');
				const statusIcon = document.getElementById('linkedin-status-icon');
				const statusText = document.getElementById('linkedin-status-text');
				
				if (!statusIndicator || !statusIcon || !statusText) return;
				
				// Show checking state
				statusIcon.className = 'w-3 h-3 rounded-full bg-blue-500 animate-pulse';
				statusText.textContent = 'Checking...';
				statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20';
				statusText.className = 'text-sm text-blue-700 dark:text-blue-300 font-medium';
				statusIndicator.title = 'Firefox LinkedIn status checker - checking...';
				
				try {
					console.log('%c[Firefox Status Check] Checking LinkedIn login status (cached if available)...', 'color: #0077b5; font-weight: bold;');
					const url = '/api/linkedin-login-status';
					const timeout = 30000; // 30s timeout - first check may take 10-20s, cached results are instant
					const result = await apiCall(url, 'GET', null, timeout);
					
					// Update UI with result
					await updateStatusFromResult(result, statusIndicator, statusIcon, statusText);
					
					// Log to console
					if (result && result.logged_in === true) {
						const cacheNote = result.cached ? ' (cached)' : '';
						const userNameNote = result.user_name ? ` as ${result.user_name}` : '';
						console.log(`%c✓ LinkedIn: LOGGED IN (Firefox)${userNameNote}${cacheNote}`, 'color: #00a86b; font-weight: bold; font-size: 14px;');
						console.log(`%c  Status: ${result.message || 'Authenticated'}`, 'color: #00a86b;');
						if (result.user_name) {
							console.log(`%c  User: ${result.user_name}`, 'color: #00a86b;');
						}
						if (result.note) {
							console.log(`%c  ${result.note}`, 'color: #00a86b;');
						}
						console.log('%c  Ready to capture leads', 'color: #00a86b;');
					} else if (result && result.logged_in === false) {
						const cacheNote = result.cached ? ' (cached)' : '';
						console.log(`%c✗ LinkedIn: NOT LOGGED IN (Firefox)${cacheNote}`, 'color: #d32f2f; font-weight: bold; font-size: 14px;');
						console.log(`%c  Status: ${result.message || 'Authentication Required'}`, 'color: #d32f2f;');
						if (result.error) {
							console.log(`%c  Error: ${result.error}`, 'color: #d32f2f;');
						}
						if (result.note) {
							console.log(`%c  ${result.note}`, 'color: #d32f2f;');
						}
						console.log('%c  Please log in to LinkedIn in your Firefox profile', 'color: #0077b5; font-weight: bold;');
					} else {
						const cacheNote = result?.cached ? ' (cached)' : '';
						console.log(`%c⚠ LinkedIn: Status Unknown (Firefox)${cacheNote}`, 'color: #ff9800; font-weight: bold; font-size: 14px;');
						console.log(`%c  Status: ${result?.message || 'Unable to determine status'}`, 'color: #ff9800;');
						if (result?.note) {
							console.log(`%c  ${result.note}`, 'color: #ff9800;');
						}
					}
				} catch (error) {
					console.log('%c⚠ LinkedIn: Status check failed (Firefox)', 'color: #ff9800; font-weight: bold; font-size: 14px;');
					console.log(`%c  Error: ${error.message || 'Unknown error'}`, 'color: #ff9800;');
					
					// Check if it's a timeout error
					const isTimeout = error.message && error.message.includes('timeout');
					
					if (isTimeout) {
						// Timeout - show warning but suggest it may still be checking
						statusIcon.className = 'w-3 h-3 rounded-full bg-yellow-500';
						statusText.textContent = 'Check timed out';
						statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-yellow-200 dark:border-yellow-800 bg-yellow-50 dark:bg-yellow-900/20';
						statusText.className = 'text-sm text-yellow-700 dark:text-yellow-300 font-medium';
						statusIndicator.title = 'Status check timed out. Firefox may still be checking in the background. Try refreshing the page in a few seconds.';
						console.log('%c  Note: The check may still be running in the background. Try refreshing in a few seconds.', 'color: #ff9800;');
					} else {
						// Other error
						statusIcon.className = 'w-3 h-3 rounded-full bg-red-500';
						statusText.textContent = 'Status check failed';
						statusIndicator.className = 'flex items-center gap-2 px-4 py-2 rounded-md border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20';
						statusText.className = 'text-sm text-red-700 dark:text-red-300 font-medium';
						statusIndicator.title = error.message || 'Failed to check LinkedIn status with Firefox';
					}
				}
			}
			
			// Initialize when DOM is ready
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', () => {
					updateStepIndicator(1);
					// Check LinkedIn status on page load and log to console
					checkLinkedInStatusOnLoad();
				});
			} else {
				updateStepIndicator(1);
				// Check LinkedIn status on page load and log to console
				checkLinkedInStatusOnLoad();
			}
		</script>
	</body>

</html>