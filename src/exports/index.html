<!DOCTYPE html>
<html lang="en" dir="ltr" data-color-theme="Green_Theme" class="selected"
	data-layout="vertical" data-boxed-layout="full" data-card="shadow">

	<head>
		@@include("../partials/head.html")
		<title>Exports - Siftin</title>
	</head>

	<body class="DEFAULT_THEME  bg-white dark:bg-dark">
		<main>
			<!--start the project-->
			<div id="main-wrapper" class="flex">

				<aside id="application-sidebar-brand"
					class="hs-overlay hs-overlay-open:translate-x-0 -translate-x-full xl:rtl:-translate-x-0 rtl:translate-x-full  left-0 rtl:left-auto rtl:right-0 transform hidden xl:block xl:translate-x-0 xl:end-auto xl:bottom-0 fixed top-0 with-vertical  left-sidebar transition-all duration-300 h-screen z-[2] flex-shrink-0 border-r rtl:border-l rtl:border-r-0 w-[270px] border-border dark:border-darkborder bg-white dark:bg-dark">
					@@include("../partials/sidebar.html",{ "page": "exports" })
				</aside>
				<div class="page-wrapper w-full" role="main">
					<!--  Header Start -->
					<header
						class="sticky top-header top-0 inset-x-0 z-[1] flex flex-wrap md:justify-start md:flex-nowrap text-sm bg-white dark:bg-dark ">
					<div
						class="with-vertical w-full">@@include("../partials/header.html")</div>
					<div class="with-horizontal w-full">
						<div class="bg-white dark:bg-dark shadow-md dark:shadow-md">
							<div class="container">
								@@include("../partials/horizontal-header.html")
							</div>
						</div>
					</div>
					</header>
					<!--  Header End -->

					<!-- Horizontal Header Menu -->
					<aside class="with-horizontal lg:flex hidden">
						@@include("../partials/horizontal-sidebar.html", { "page": "exports",
						})
					</aside>
					<!-- Horizontal Header Menu End -->

					<!-- Main Content -->
					<main class="h-full max-w-full pt-6">
						<div class="container full-container py-5">
							<!-- Page Title -->
							<div class="mb-8">
								<div class="flex items-center justify-between mb-2">
									<div>
										<h1 class="text-3xl font-bold text-dark dark:text-white mb-2">Exports</h1>
										<p class="text-base text-link dark:text-darklink">View and manage your lead exports</p>
									</div>
								</div>
							</div>

							<!-- Loading Indicator -->
							<div id="loading-indicator" class="hidden mb-6">
								<div class="card">
									<div class="card-body text-center py-8">
										<div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
										<p class="mt-4 text-link dark:text-darklink">Loading exports...</p>
									</div>
								</div>
							</div>

							<!-- Error Message -->
							<div id="error-message" class="hidden mb-6">
								<div class="card bg-lightdanger dark:bg-darkdanger border border-danger">
									<div class="card-body">
										<div class="flex items-center gap-3">
											<i class="ti ti-alert-circle text-danger text-xl"></i>
											<div>
												<h5 class="font-semibold text-danger mb-1">Error</h5>
												<p id="error-text" class="text-sm text-danger"></p>
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- Export History -->
							<div class="card">
								<div class="card-body">
									<h2 class="text-xl font-bold text-dark dark:text-white mb-6">Export History</h2>
									
									<div class="overflow-x-auto">
										<table class="w-full">
											<thead class="bg-lightprimary dark:bg-darkprimary">
												<tr>
													<th class="px-4 py-3 text-left text-xs font-semibold text-dark dark:text-white uppercase">CREATED</th>
													<th class="px-4 py-3 text-left text-xs font-semibold text-dark dark:text-white uppercase">DESTINATION</th>
													<th class="px-4 py-3 text-left text-xs font-semibold text-dark dark:text-white uppercase">RECORDS</th>
													<th class="px-4 py-3 text-left text-xs font-semibold text-dark dark:text-white uppercase">MAPPING</th>
													<th class="px-4 py-3 text-left text-xs font-semibold text-dark dark:text-white uppercase">STATUS</th>
													<th class="px-4 py-3 text-left text-xs font-semibold text-dark dark:text-white uppercase">ACTIONS</th>
												</tr>
											</thead>
											<tbody id="exports-table-body" class="divide-y divide-border dark:divide-darkborder">
												<!-- Exports will be dynamically inserted here -->
											</tbody>
										</table>
									</div>
								</div>
							</div>

							<!-- Empty State -->
							<div id="empty-state" class="hidden">
								<div class="card">
									<div class="card-body text-center py-12">
										<i class="ti ti-download text-6xl text-link dark:text-darklink mb-4 opacity-50"></i>
										<h3 class="text-xl font-semibold text-dark dark:text-white mb-2">No exports found</h3>
										<p class="text-link dark:text-darklink mb-6">You haven't exported any leads yet.</p>
										<a href="../runs/" class="btn btn-primary">
											<i class="ti ti-player-play mr-2"></i> View Runs
										</a>
									</div>
								</div>
							</div>

						</div>
					</main>
					<!-- Main Content End -->

				</div>
			</div>
			<!--end of project-->
		</main>
		@@include("../partials/header-components/mobile-menu.html")
		@@include("../partials/header-components/dd-searchbar.html")
		@@include("../partials/header-components/dd-cart.html")
		@@include("../partials/customizer.html")
		@@include("../partials/scripts.html")
		
		<script>
			// API Configuration
			const API_BASE_URL = 'http://localhost:8000';
			
			// Helper function for API calls
			async function apiCall(endpoint, method = 'GET', data = null) {
				try {
					const options = {
						method,
						headers: {
							'Content-Type': 'application/json',
						}
					};
					
					if (data) {
						options.body = JSON.stringify(data);
					}
					
					const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
					
					if (!response.ok) {
						const errorData = await response.json().catch(() => ({ detail: response.statusText }));
						throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
					}
					
					return await response.json();
				} catch (error) {
					console.error('[API] Error:', error);
					throw error;
				}
			}

			// Show/hide loading indicator
			function showLoading(show) {
				const loadingEl = document.getElementById('loading-indicator');
				if (loadingEl) {
					loadingEl.classList.toggle('hidden', !show);
				}
			}

			// Show error message
			function showError(message) {
				const errorEl = document.getElementById('error-message');
				const errorText = document.getElementById('error-text');
				if (errorEl && errorText) {
					errorText.textContent = message;
					errorEl.classList.remove('hidden');
				}
			}

			// Hide error message
			function hideError() {
				const errorEl = document.getElementById('error-message');
				if (errorEl) {
					errorEl.classList.add('hidden');
				}
			}

			// Format date for display
			function formatExportDate(dateString) {
				if (!dateString) return { date: 'N/A', time: '' };
				const date = new Date(dateString);
				const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
				const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
				return { date: dateStr, time: timeStr };
			}

			// Get destination icon
			function getDestinationIcon(destination) {
				switch(destination.toLowerCase()) {
					case 'csv':
						return 'ti ti-file-text';
					case 'hubspot':
						return 'ti ti-database';
					case 'salesforce':
						return 'ti ti-cloud';
					default:
						return 'ti ti-file';
				}
			}

			// Get status badge
			function getStatusBadge(status) {
				const statusLower = status.toLowerCase();
				
				if (statusLower === 'sent' || statusLower === 'success' || statusLower === 'completed') {
					return '<span class="px-2 py-1 text-xs font-medium rounded-md bg-lightsuccess dark:bg-darksuccess text-success">Sent</span>';
				} else if (statusLower === 'error' || statusLower === 'failed') {
					return '<span class="px-2 py-1 text-xs font-medium rounded-md bg-lightdanger dark:bg-darkdanger text-danger">Error</span>';
				} else if (statusLower === 'pending') {
					return '<span class="px-2 py-1 text-xs font-medium rounded-md bg-lightwarning dark:bg-darkwarning text-warning">Pending</span>';
				} else {
					return '<span class="px-2 py-1 text-xs font-medium rounded-md bg-lightsecondary dark:bg-darksecondary text-link dark:text-darklink">' + escapeHtml(status) + '</span>';
				}
			}

			// Load exports from runs
			async function loadExports() {
				showLoading(true);
				hideError();
				
				try {
					// Get all runs
					const runsResponse = await apiCall('/api/capture/runs');
					const runs = runsResponse.runs || [];
					
					// Filter runs that have been exported (status success and have leads)
					const exportedRuns = runs.filter(run => 
						run.status === 'success' && run.total_leads > 0
					);
					
					// Build exports list from runs
					// In a real system, you'd have a separate exports table, but for now we'll derive from runs
					const exports = [];
					
					for (const run of exportedRuns) {
						// Check if this run has been exported (we'll assume CSV for now)
						// In production, you'd track actual export history
						const exportDate = run.created_at || new Date().toISOString();
						
						// Create export entries - one per run (CSV export)
						exports.push({
							id: run.id,
							run_id: run.id,
							created_at: exportDate,
							destination: 'CSV',
							records: run.selected_leads || run.total_leads,
							mapping: 'Default CSV',
							status: 'sent',
							download_url: null // Will be generated on demand
						});
					}
					
					// Sort by created date (newest first)
					exports.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
					
					showLoading(false);
					
					const tableBody = document.getElementById('exports-table-body');
					const emptyState = document.getElementById('empty-state');
					
					if (exports.length === 0) {
						if (tableBody) tableBody.innerHTML = '';
						if (emptyState) emptyState.classList.remove('hidden');
						return;
					}
					
					if (emptyState) emptyState.classList.add('hidden');
					
					if (tableBody) {
						tableBody.innerHTML = exports.map(exp => {
							const dateInfo = formatExportDate(exp.created_at);
							const icon = getDestinationIcon(exp.destination);
							const statusBadge = getStatusBadge(exp.status);
							const hasError = exp.status.toLowerCase() === 'error' || exp.status.toLowerCase() === 'failed';
							
							return `
								<tr class="hover:bg-lightprimary dark:hover:bg-darkprimary transition-colors">
									<td class="px-4 py-3">
										<div class="text-sm text-dark dark:text-white">${escapeHtml(dateInfo.date)}</div>
										<div class="text-xs text-link dark:text-darklink">${escapeHtml(dateInfo.time)}</div>
									</td>
									<td class="px-4 py-3">
										<div class="flex items-center gap-2">
											<i class="${icon} text-link dark:text-darklink"></i>
											<span class="text-sm text-dark dark:text-white">${escapeHtml(exp.destination)}</span>
										</div>
									</td>
									<td class="px-4 py-3 text-sm text-dark dark:text-white">${exp.records}</td>
									<td class="px-4 py-3 text-sm text-link dark:text-darklink">${escapeHtml(exp.mapping)}</td>
									<td class="px-4 py-3">${statusBadge}</td>
									<td class="px-4 py-3">
										<div class="flex items-center gap-2">
											<button onclick="viewExport(${exp.id})" class="text-link dark:text-darklink hover:text-primary transition-colors cursor-pointer" title="View">
												<i class="ti ti-eye text-lg"></i>
											</button>
											${hasError ? `
											<button onclick="retryExport(${exp.id})" class="text-link dark:text-darklink hover:text-primary transition-colors cursor-pointer" title="Retry">
												<i class="ti ti-refresh text-lg"></i>
											</button>
											` : ''}
											<button onclick="deleteExport(${exp.id})" class="text-danger hover:text-danger/80 transition-colors cursor-pointer" title="Delete">
												<i class="ti ti-trash text-lg"></i>
											</button>
										</div>
									</td>
								</tr>
							`;
						}).join('');
					}
				} catch (error) {
					showLoading(false);
					showError(error.message || 'Failed to load exports');
					console.error('[Exports] Error loading exports:', error);
				}
			}

			// View export details
			async function viewExport(exportId) {
				try {
					// Get the run details
					const run = await apiCall(`/api/capture/runs/${exportId}`);
					
					// Show export details in a modal or alert
					const message = `
Export Details:
Run ID: ${run.id}
Run Label: ${run.run_label}
Records: ${run.selected_leads || run.total_leads}
Created: ${formatExportDate(run.created_at).date} ${formatExportDate(run.created_at).time}
Destination: CSV
Mapping: Default CSV
					`.trim();
					
					alert(message);
				} catch (error) {
					showError(error.message || 'Failed to load export details');
				}
			}

			// Retry export
			async function retryExport(exportId) {
				try {
					showLoading(true);
					const response = await apiCall(`/api/capture/runs/${exportId}/export?selected_only=true`, 'POST');
					
					if (response.download_url) {
						window.location.href = `${API_BASE_URL}${response.download_url}`;
					}
					
					showLoading(false);
					loadExports(); // Reload the list
				} catch (error) {
					showLoading(false);
					showError(error.message || 'Failed to retry export');
				}
			}

			// Delete export
			async function deleteExport(exportId) {
				if (!confirm('Are you sure you want to delete this export record? This action cannot be undone.')) {
					return;
				}
				
				try {
					showLoading(true);
					// Note: In a real system, you'd delete the export record, not the run
					// For now, we'll just reload the list
					showLoading(false);
					loadExports(); // Reload the list
				} catch (error) {
					showLoading(false);
					showError(error.message || 'Failed to delete export');
				}
			}

			// Download export
			async function downloadExport(exportId) {
				try {
					showLoading(true);
					const response = await apiCall(`/api/capture/runs/${exportId}/export?selected_only=true`, 'POST');
					
					if (response.download_url) {
						window.location.href = `${API_BASE_URL}${response.download_url}`;
					}
					
					showLoading(false);
				} catch (error) {
					showLoading(false);
					showError(error.message || 'Failed to download export');
				}
			}

			// Escape HTML to prevent XSS
			function escapeHtml(text) {
				if (!text) return '';
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			}

			// Load exports on page load
			document.addEventListener('DOMContentLoaded', function() {
				loadExports();
			});
		</script>
	</body>
</html>

